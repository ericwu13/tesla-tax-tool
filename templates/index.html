<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tax Calculator</title>
<style>
  :root {
    --bg: #f5f5f7;
    --card: #fff;
    --border: #d1d5db;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --text: #1f2937;
    --muted: #6b7280;
    --green: #059669;
    --red: #dc2626;
    --radius: 8px;
    --orange: #d97706;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    padding: 2rem;
    max-width: 900px;
    margin: 0 auto;
  }
  h1 { font-size: 1.5rem; margin-bottom: 1.5rem; }
  h2 { font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--muted); font-weight: 500; }

  /* Mode toggle */
  .mode-toggle {
    display: flex;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  .mode-toggle button {
    flex: 1;
    padding: 0.6rem 1rem;
    border: none;
    background: transparent;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
    border-radius: 0;
  }
  .mode-toggle button.active {
    background: var(--accent);
    color: #fff;
  }

  /* Settings bar */
  .settings {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .settings label {
    display: flex;
    flex-direction: column;
    font-size: 0.8rem;
    color: var(--muted);
    gap: 0.25rem;
  }
  .settings select, .settings input {
    padding: 0.4rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.9rem;
    background: var(--card);
  }

  /* Drop zone */
  .dropzone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 3rem 2rem;
    text-align: center;
    color: var(--muted);
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-bottom: 1.5rem;
    position: relative;
  }
  .dropzone.active {
    border-color: var(--accent);
    background: #eff6ff;
  }
  .dropzone p { margin-bottom: 0.5rem; }
  .dropzone .hint { font-size: 0.8rem; }
  .dropzone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
  }
  .card h3 {
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card h3 .tag {
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: #e0e7ff;
    color: var(--accent);
    font-weight: 500;
  }
  .card .fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.4rem 1.5rem;
  }
  .card .field {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
  }
  .card .field span:first-child { color: var(--muted); }
  .card .field input {
    width: 120px;
    text-align: right;
    padding: 0.15rem 0.4rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.85rem;
  }

  /* Buttons */
  button {
    padding: 0.6rem 1.5rem;
    border: none;
    border-radius: var(--radius);
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.15s;
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-primary:disabled {
    background: var(--border);
    cursor: not-allowed;
  }
  .btn-secondary {
    background: #e5e7eb;
    color: var(--text);
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
  .btn-secondary:hover { background: #d1d5db; }
  .btn-danger {
    background: #fee2e2;
    color: var(--red);
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  /* Summary cards */
  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .summary-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
  }
  .summary-card h3 {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
    margin-bottom: 0.75rem;
  }
  .summary-card .big-number {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  .summary-card .big-number.refund { color: var(--green); }
  .summary-card .big-number.due { color: var(--red); }
  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    padding: 0.15rem 0;
    color: var(--muted);
  }
  .summary-row span:last-child { color: var(--text); font-weight: 500; }

  /* Projection banner */
  .projection-banner {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: var(--radius);
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.85rem;
    color: #92400e;
  }
  .projection-banner strong { color: var(--orange); }

  /* Assumptions card */
  .assumptions-card {
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
  }
  .assumptions-card h3 {
    font-size: 0.85rem;
    color: var(--orange);
    margin-bottom: 0.5rem;
  }
  .assumptions-card .fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.3rem 1.5rem;
  }
  .assumptions-card .field {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
  }
  .assumptions-card .field span:first-child { color: #92400e; }
  .assumptions-card .field span:last-child { font-weight: 500; }

  /* Report */
  .report {
    background: #1e293b;
    color: #e2e8f0;
    border-radius: var(--radius);
    padding: 1.5rem;
    font-family: 'SF Mono', 'Consolas', 'Courier New', monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    overflow-x: auto;
    line-height: 1.6;
    margin-top: 1rem;
  }

  /* Status */
  .status {
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
    font-size: 0.85rem;
    display: none;
  }
  .status.info { display: block; background: #dbeafe; color: #1e40af; }
  .status.error { display: block; background: #fee2e2; color: var(--red); }
  .status.success { display: block; background: #d1fae5; color: var(--green); }

  .hidden { display: none; }

  /* Raw text toggle */
  .raw-toggle {
    font-size: 0.75rem;
    color: var(--accent);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-weight: 400;
    text-decoration: underline;
    margin-top: 0.5rem;
  }
  .raw-text {
    background: #f8f9fa;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.75rem;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 0.7rem;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 0.5rem;
    color: var(--muted);
  }

  /* Spinner */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 0.5rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Mid-year specific */
  .midyear-section .card { border-left: 3px solid var(--orange); }
  .vest-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }
  .vest-table th {
    text-align: left;
    padding: 0.4rem 0.5rem;
    border-bottom: 2px solid var(--border);
    color: var(--muted);
    font-weight: 500;
    font-size: 0.75rem;
  }
  .vest-table td {
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid #f0f0f0;
  }
  .vest-table tr.future { background: #fffbeb; }
  .vest-table tr.past { color: var(--muted); }
  .vest-table .badge {
    font-size: 0.65rem;
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-weight: 500;
  }
  .vest-table .badge.future { background: #fef3c7; color: #92400e; }
  .vest-table .badge.past { background: #e5e7eb; color: var(--muted); }

  .sale-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
  }
  .sale-row input[type="number"] {
    width: 110px;
    padding: 0.3rem 0.4rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.85rem;
  }
  .sale-row label {
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
</style>
</head>
<body>

<h1>Tax Calculator</h1>

<!-- Mode Toggle -->
<div class="mode-toggle">
  <button id="modeYearEnd" class="active" onclick="switchMode('yearend')">Year-End Filing</button>
  <button id="modeMidYear" onclick="switchMode('midyear')">Mid-Year Estimate</button>
</div>

<div class="settings">
  <label>
    Filing Status
    <select id="filingStatus">
      <option value="single">Single</option>
      <option value="mfj">Married Filing Jointly</option>
      <option value="mfs">Married Filing Separately</option>
      <option value="hoh">Head of Household</option>
    </select>
  </label>
  <label>
    Tax Year
    <input type="number" id="taxYear" value="2026" min="2020" max="2030">
  </label>
  <label>
    Estimated Payments
    <input type="number" id="estimatedPayments" value="0" min="0" step="100" placeholder="$0">
  </label>
</div>

<!-- ===== YEAR-END MODE ===== -->
<div id="yearEndPanel">
  <div class="card" style="margin-bottom:1.5rem">
    <h3>Deductions <span class="tag">Manual Entry</span></h3>
    <div class="fields">
      <div class="field">
        <span>Annual Mortgage Interest ($)</span>
        <input type="number" id="mortgageInterest" value="" min="0" step="100" placeholder="from 1098 Box 1">
      </div>
      <div class="field">
        <span>Annual Property Tax ($)</span>
        <input type="number" id="propertyTax" value="" min="0" step="100" placeholder="e.g. 12000">
      </div>
      <div class="field" style="align-items:center;color:var(--muted);font-size:0.8rem">— or estimate property tax from home value —</div>
      <div class="field">
        <span>Home Value ($)</span>
        <input type="number" id="homeValue" value="" min="0" step="10000" placeholder="e.g. 1500000">
      </div>
      <div class="field">
        <span>Tax Rate (%)</span>
        <input type="number" id="taxRate" value="1.2" min="0" max="5" step="0.01">
      </div>
      <div class="field">
        <span>Rental Use (%)</span>
        <input type="number" id="rentalPct" value="0" min="0" max="100" step="1" placeholder="0 if none">
      </div>
    </div>
    <p id="propTaxEstimate" style="font-size:0.8rem;color:var(--muted);margin-top:0.5rem"></p>
  </div>

  <div class="dropzone" id="dropzone">
    <p>Drop PDF tax forms here or click to browse</p>
    <p class="hint">Supports W-2, 1099-B, 1099-INT, 1098</p>
    <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg,.tiff,.tif,.bmp">
  </div>

  <div class="status" id="status"></div>

  <div id="formsSection" class="hidden">
    <h2>Extracted Data — review and edit values</h2>
    <div id="formCards"></div>
    <button class="btn-primary" id="calcBtn" onclick="calculate()">Calculate Taxes</button>
  </div>
</div>

<!-- ===== MID-YEAR MODE ===== -->
<div id="midYearPanel" class="hidden midyear-section">

  <!-- Paystub Section -->
  <div class="card">
    <h3>Paystub Data <span class="tag" style="background:#fef3c7;color:#92400e">YTD</span></h3>
    <div class="dropzone" id="paystubDropzone" style="padding:1rem;margin-bottom:0.75rem">
      <p style="margin:0;font-size:0.85rem">Drop paystub PDF here or click to browse</p>
      <p class="hint">Workday / Tesla paystub — auto-extracts YTD totals</p>
      <input type="file" id="paystubFileInput" accept=".pdf">
    </div>
    <div id="paystubParsed" class="hidden" style="font-size:0.8rem;color:var(--green);margin-bottom:0.75rem"></div>
    <div class="fields">
      <div class="field">
        <span>YTD Gross Wages ($)</span>
        <input type="number" id="ytdGrossWages" value="" min="0" step="100" placeholder="Total from paystub">
      </div>
      <div class="field">
        <span>YTD RSU Income ($)</span>
        <input type="number" id="ytdRsuIncome" value="" min="0" step="100" placeholder="RSU portion of wages">
      </div>
      <div class="field">
        <span>YTD Federal Withheld ($)</span>
        <input type="number" id="ytdFedWithheld" value="" min="0" step="100" placeholder="Fed tax withheld">
      </div>
      <div class="field">
        <span>YTD State Withheld ($)</span>
        <input type="number" id="ytdStateWithheld" value="" min="0" step="100" placeholder="CA tax withheld">
      </div>
      <div class="field" style="grid-column: 1 / -1">
        <span>Pay Date</span>
        <input type="date" id="payDate" value="" style="width:160px">
      </div>
    </div>
    <!-- Live projected annual preview -->
    <div id="projectedPreview" class="hidden" style="margin-top:0.75rem;padding:0.75rem;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;font-size:0.8rem">
      <div style="font-weight:600;color:var(--green);margin-bottom:0.4rem">Projected Full-Year Estimate</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.25rem 1.5rem">
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Year progress</span><span id="prevYearPct" style="font-weight:500"></span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Annual base salary</span><span id="prevBaseSalary" style="font-weight:500"></span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Future RSU income</span><span id="prevRsuIncome" style="font-weight:500"></span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Projected W-2 wages</span><span id="prevW2Wages" style="font-weight:600;color:var(--text)"></span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Projected fed withheld</span><span id="prevFedWH" style="font-weight:500"></span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Projected state withheld</span><span id="prevStateWH" style="font-weight:500"></span></div>
      </div>
    </div>
  </div>

  <!-- Vesting Schedule Section -->
  <div class="card">
    <h3>Vesting Schedule <span class="tag" style="background:#fef3c7;color:#92400e">RSU / ESPP</span></h3>
    <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:0.75rem">
      <div class="dropzone" id="vestDropzone" style="padding:1rem;margin:0;flex:1">
        <p style="margin:0;font-size:0.85rem">Drop E*TRADE XLSX or click to browse</p>
        <input type="file" id="vestFileInput" accept=".xlsx,.xls">
      </div>
      <span style="color:var(--muted);font-size:0.8rem">or add manually below</span>
    </div>
    <div style="display:flex;gap:0.75rem;align-items:flex-end;margin-bottom:0.75rem;flex-wrap:wrap">
      <label style="font-size:0.8rem;color:var(--muted)">
        Estimated Stock Price ($)
        <input type="number" id="estimatedStockPrice" value="" min="0" step="1" placeholder="e.g. 400" style="width:110px;padding:0.3rem 0.4rem;border:1px solid var(--border);border-radius:4px;font-size:0.85rem">
      </label>
      <button class="btn-secondary" onclick="addManualVest()">+ Add Vest Event</button>
    </div>
    <div id="vestTableContainer"></div>
  </div>

  <!-- Planned Sales Section -->
  <div class="card">
    <h3>Planned Stock Sales <span class="tag" style="background:#fef3c7;color:#92400e">Capital Gains</span></h3>
    <div id="plannedSalesContainer"></div>
    <button class="btn-secondary" onclick="addPlannedSale()" style="margin-top:0.5rem">+ Add Sale</button>
  </div>

  <!-- Other Estimates -->
  <div class="card">
    <h3>Other Estimates <span class="tag" style="background:#fef3c7;color:#92400e">Annual</span></h3>
    <div class="fields">
      <div class="field">
        <span>Interest Income ($)</span>
        <input type="number" id="midEstInterest" value="" min="0" step="10" placeholder="e.g. 500">
      </div>
      <div class="field">
        <span>Mortgage Interest ($)</span>
        <input type="number" id="midMortgageInterest" value="" min="0" step="100" placeholder="Annual total">
      </div>
      <div class="field">
        <span>Property Taxes ($)</span>
        <input type="number" id="midPropertyTax" value="" min="0" step="100" placeholder="Annual total">
      </div>
      <div class="field">
        <span>Rental Use (%)</span>
        <input type="number" id="midRentalPct" value="0" min="0" max="100" step="1" placeholder="0 if none">
      </div>
    </div>
  </div>

  <div class="status" id="midStatus"></div>

  <button class="btn-primary" id="midCalcBtn" onclick="calculateMidYear()" style="margin-top:0.5rem">Project Full-Year Taxes</button>
</div>

<!-- ===== RESULTS (shared) ===== -->
<div id="projectionBanner" class="projection-banner hidden"></div>

<div id="assumptionsSection" class="hidden">
  <div class="assumptions-card" id="assumptionsCard"></div>
</div>

<div id="summarySection" class="hidden">
  <h2>Summary</h2>
  <div class="summary-grid">
    <div class="summary-card">
      <h3>Federal</h3>
      <div class="big-number" id="fedResult"></div>
      <div class="summary-row"><span>Total Income (AGI)</span><span id="fedAgi"></span></div>
      <div class="summary-row"><span>Deductions</span><span id="fedDeduction"></span></div>
      <div class="summary-row"><span>Taxable Income</span><span id="fedTaxable"></span></div>
      <div class="summary-row"><span>Federal Tax</span><span id="fedTax"></span></div>
      <div class="summary-row"><span>Withheld / Paid</span><span id="fedWithheld"></span></div>
      <div class="summary-row"><span>Effective Rate</span><span id="fedRate"></span></div>
    </div>
    <div class="summary-card">
      <h3>California</h3>
      <div class="big-number" id="caResult"></div>
      <div class="summary-row"><span>Total Income</span><span id="caIncome"></span></div>
      <div class="summary-row"><span>Taxable Income</span><span id="caTaxable"></span></div>
      <div class="summary-row"><span>CA Tax</span><span id="caTax"></span></div>
      <div class="summary-row"><span>Withheld</span><span id="caWithheld"></span></div>
      <div class="summary-row"><span>Effective Rate</span><span id="caRate"></span></div>
    </div>
  </div>
</div>

<div id="reportSection" class="hidden">
  <h2>Detailed Report</h2>
  <div class="report" id="reportOutput"></div>
</div>

<script>
// ===== Mode management =====
let currentMode = 'yearend';

function switchMode(mode) {
  currentMode = mode;
  document.getElementById('modeYearEnd').classList.toggle('active', mode === 'yearend');
  document.getElementById('modeMidYear').classList.toggle('active', mode === 'midyear');
  document.getElementById('yearEndPanel').classList.toggle('hidden', mode !== 'yearend');
  document.getElementById('midYearPanel').classList.toggle('hidden', mode !== 'midyear');
  // Hide results when switching modes
  document.getElementById('summarySection').classList.add('hidden');
  document.getElementById('reportSection').classList.add('hidden');
  document.getElementById('projectionBanner').classList.add('hidden');
  document.getElementById('assumptionsSection').classList.add('hidden');
}

// ===== Year-End Mode (existing logic) =====
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const status = document.getElementById('status');
const formsSection = document.getElementById('formsSection');
const formCards = document.getElementById('formCards');
const reportSection = document.getElementById('reportSection');
const reportOutput = document.getElementById('reportOutput');
const calcBtn = document.getElementById('calcBtn');

let scannedForms = [];

// Property tax estimate from home value
const homeValueInput = document.getElementById('homeValue');
const taxRateInput = document.getElementById('taxRate');
const propTaxDirect = document.getElementById('propertyTax');
const propTaxEstimate = document.getElementById('propTaxEstimate');

function updatePropTaxEstimate() {
  const hv = parseFloat(homeValueInput.value) || 0;
  const rate = parseFloat(taxRateInput.value) || 0;
  if (hv > 0 && rate > 0) {
    const est = hv * rate / 100;
    propTaxEstimate.textContent = `Estimated annual property tax: $${est.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}`;
  } else {
    propTaxEstimate.textContent = '';
  }
}
homeValueInput.addEventListener('input', updatePropTaxEstimate);
taxRateInput.addEventListener('input', updatePropTaxEstimate);

function getPropertyTax() {
  const direct = parseFloat(propTaxDirect.value);
  if (direct > 0) return direct;
  const hv = parseFloat(homeValueInput.value) || 0;
  const rate = parseFloat(taxRateInput.value) || 0;
  if (hv > 0 && rate > 0) return hv * rate / 100;
  return 0;
}

function escapeHtml(s) {
  const el = document.createElement('div');
  el.textContent = s;
  return el.innerHTML;
}

// Drag and drop
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('active'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('active'));
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('active');
  if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files.length) uploadFiles(fileInput.files);
});

function showStatus(msg, type, elId) {
  const el = document.getElementById(elId || 'status');
  el.textContent = msg;
  el.className = 'status ' + type;
}

function clearStatus(elId) {
  const el = document.getElementById(elId || 'status');
  el.className = 'status';
  el.textContent = '';
}

async function uploadFiles(files) {
  const fd = new FormData();
  for (const f of files) fd.append('files', f);
  fd.append('tax_year', document.getElementById('taxYear').value);

  showStatus(`Scanning ${files.length} file(s)...`, 'info');
  formsSection.classList.add('hidden');
  document.getElementById('summarySection').classList.add('hidden');
  reportSection.classList.add('hidden');
  document.getElementById('projectionBanner').classList.add('hidden');
  document.getElementById('assumptionsSection').classList.add('hidden');

  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Upload failed');

    scannedForms = data.forms;
    renderCards(scannedForms);
    formsSection.classList.remove('hidden');
    clearStatus();
  } catch (err) {
    showStatus('Error: ' + err.message, 'error');
  }
}

function renderCards(forms) {
  formCards.innerHTML = '';
  forms.forEach((form, i) => {
    const card = document.createElement('div');
    card.className = 'card';

    if (form.form_type === 'error') {
      card.innerHTML = `<h3>${form.source_file} <span class="tag" style="background:#fee2e2;color:#dc2626">Error</span></h3>
        <p style="font-size:0.85rem;color:#dc2626">${form.data.error}</p>`;
      formCards.appendChild(card);
      return;
    }

    let fieldsHtml = '';
    const d = form.data;

    if (form.form_type === 'W-2') {
      fieldsHtml = makeField(i, 'wages', 'Wages (Box 1)', d.wages) +
        makeField(i, 'federal_tax_withheld', 'Fed Withheld (Box 2)', d.federal_tax_withheld) +
        makeField(i, 'state_wages', 'State Wages (Box 16)', d.state_wages) +
        makeField(i, 'state_tax_withheld', 'State Tax (Box 17)', d.state_tax_withheld);
    } else if (form.form_type === '1099-INT') {
      fieldsHtml = makeField(i, 'total_interest', 'Total Interest', d.total_interest);
    } else if (form.form_type === '1098') {
      fieldsHtml = makeField(i, 'mortgage_interest', 'Mortgage Interest', d.mortgage_interest) +
        makeField(i, 'property_taxes', 'Property Taxes', d.property_taxes) +
        makeField(i, 'mortgage_insurance', 'Mortgage Insurance', d.mortgage_insurance);
    } else if (form.form_type === '1099-B') {
      const lots = Array.isArray(d) ? d : [];
      const stGain = lots.filter(t => !t.is_long_term).reduce((s,t) => s + (t.total_gain||0), 0);
      const ltGain = lots.filter(t => t.is_long_term).reduce((s,t) => s + (t.total_gain||0), 0);
      const missingCB = lots.filter(t => t.cost_basis_missing);
      fieldsHtml = `<div class="field"><span>Transactions</span><span>${lots.length}</span></div>` +
        `<div class="field"><span>Short-term gain</span><span>$${stGain.toLocaleString(undefined,{minimumFractionDigits:2})}</span></div>` +
        `<div class="field"><span>Long-term gain</span><span>$${ltGain.toLocaleString(undefined,{minimumFractionDigits:2})}</span></div>`;
      if (missingCB.length > 0) {
        const missingTotal = missingCB.reduce((s,t) => s + (t.total_gain||0), 0);
        fieldsHtml += `<div class="field" style="color:var(--orange);font-size:0.82rem;margin-top:0.3rem">` +
          `<span>&#9888; Noncovered securities</span>` +
          `<span>$${missingTotal.toLocaleString(undefined,{minimumFractionDigits:2})} gain (cost basis not reported — verify)</span></div>`;
      }
      const adjusted = lots.filter(t => !t.is_covered && !t.cost_basis_missing && t.cost_basis > 0);
      if (adjusted.length > 0) {
        fieldsHtml += `<div class="field" style="color:var(--green);font-size:0.82rem">` +
          `<span>Same-day RSU sales adjusted</span>` +
          `<span>Cost basis set to proceeds (gain ~ $0)</span></div>`;
      }
    } else {
      fieldsHtml = `<div class="field"><span>Type</span><span>${form.form_type}</span></div>`;
    }

    const rawId = 'raw_' + i;
    const rawToggle = form.raw_text
      ? `<button class="raw-toggle" onclick="document.getElementById('${rawId}').classList.toggle('hidden')">Show raw text</button>
         <div id="${rawId}" class="raw-text hidden">${escapeHtml(form.raw_text)}</div>`
      : '';

    card.innerHTML = `<h3>${form.source_file} <span class="tag">${form.form_type}</span></h3>
      <div class="fields">${fieldsHtml}</div>${rawToggle}`;
    formCards.appendChild(card);
  });
}

function makeField(formIdx, key, label, value) {
  const v = value || 0;
  return `<div class="field">
    <span>${label}</span>
    <input type="number" step="0.01" data-form="${formIdx}" data-key="${key}" value="${v}">
  </div>`;
}

function collectCorrectedForms() {
  const forms = JSON.parse(JSON.stringify(scannedForms));
  document.querySelectorAll('#formCards input[data-form]').forEach(input => {
    const fi = parseInt(input.dataset.form);
    const key = input.dataset.key;
    forms[fi].data[key] = parseFloat(input.value) || 0;
  });
  return forms;
}

async function calculate() {
  const forms = collectCorrectedForms();
  const payload = {
    forms: forms,
    filing_status: document.getElementById('filingStatus').value,
    tax_year: parseInt(document.getElementById('taxYear').value),
    estimated_payments: parseFloat(document.getElementById('estimatedPayments').value) || 0,
    property_tax: getPropertyTax(),
    mortgage_interest: parseFloat(document.getElementById('mortgageInterest').value) || 0,
    rental_pct: (parseFloat(document.getElementById('rentalPct').value) || 0) / 100,
  };

  calcBtn.disabled = true;
  showStatus('Calculating...', 'info');

  try {
    const res = await fetch('/calculate', { method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Calculation failed');

    document.getElementById('projectionBanner').classList.add('hidden');
    document.getElementById('assumptionsSection').classList.add('hidden');
    displayResults(data);
    clearStatus();
  } catch (err) {
    showStatus('Error: ' + err.message, 'error');
  } finally {
    calcBtn.disabled = false;
  }
}

// ===== Shared results display =====
const fmt = v => '$' + Math.abs(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

function displayResults(data) {
  const f = data.federal;

  if (f.refund > 0) {
    document.getElementById('fedResult').textContent = fmt(f.refund) + ' refund';
    document.getElementById('fedResult').className = 'big-number refund';
  } else {
    document.getElementById('fedResult').textContent = fmt(f.net_due) + ' owed';
    document.getElementById('fedResult').className = 'big-number due';
  }
  document.getElementById('fedAgi').textContent = fmt(f.agi);
  document.getElementById('fedDeduction').textContent = '(' + fmt(f.deduction_amount) + ') ' + f.deduction_type;
  document.getElementById('fedTaxable').textContent = fmt(f.taxable_income);
  document.getElementById('fedTax').textContent = fmt(f.total_tax);
  document.getElementById('fedWithheld').textContent = fmt(f.withheld);
  document.getElementById('fedRate').textContent = f.effective_rate.toFixed(1) + '%';

  const ca = data.california;
  if (ca && ca.total_tax !== undefined) {
    if (ca.refund > 0) {
      document.getElementById('caResult').textContent = fmt(ca.refund) + ' refund';
      document.getElementById('caResult').className = 'big-number refund';
    } else {
      document.getElementById('caResult').textContent = fmt(ca.net_due) + ' owed';
      document.getElementById('caResult').className = 'big-number due';
    }
    document.getElementById('caIncome').textContent = fmt(ca.total_income);
    document.getElementById('caTaxable').textContent = fmt(ca.taxable_income);
    document.getElementById('caTax').textContent = fmt(ca.total_tax);
    document.getElementById('caWithheld').textContent = fmt(ca.withheld);
    document.getElementById('caRate').textContent = ca.effective_rate.toFixed(1) + '%';
  } else {
    document.getElementById('caResult').textContent = 'N/A';
    document.getElementById('caResult').className = 'big-number';
    ['caIncome','caTaxable','caTax','caWithheld','caRate'].forEach(
      id => document.getElementById(id).textContent = '-');
  }

  document.getElementById('summarySection').classList.remove('hidden');
  reportOutput.textContent = data.report;
  reportSection.classList.remove('hidden');
  document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
}

// ===== Mid-Year Mode =====
let vestingEvents = [];
let plannedSales = [];

// Paystub PDF upload
const paystubDropzone = document.getElementById('paystubDropzone');
const paystubFileInput = document.getElementById('paystubFileInput');

paystubDropzone.addEventListener('dragover', e => { e.preventDefault(); paystubDropzone.classList.add('active'); });
paystubDropzone.addEventListener('dragleave', () => paystubDropzone.classList.remove('active'));
paystubDropzone.addEventListener('drop', e => {
  e.preventDefault();
  paystubDropzone.classList.remove('active');
  if (e.dataTransfer.files.length) uploadPaystubFile(e.dataTransfer.files[0]);
});
paystubFileInput.addEventListener('change', () => {
  if (paystubFileInput.files.length) uploadPaystubFile(paystubFileInput.files[0]);
});

async function uploadPaystubFile(file) {
  const fd = new FormData();
  fd.append('file', file);
  showStatus('Parsing paystub...', 'info', 'midStatus');

  try {
    const res = await fetch('/upload_paystub', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Upload failed');

    const p = data.paystub;
    // Auto-populate the fields
    document.getElementById('ytdGrossWages').value = p.ytd_gross_wages || '';
    document.getElementById('ytdRsuIncome').value = p.ytd_rsu_income || '';
    document.getElementById('ytdFedWithheld').value = p.ytd_fed_withheld || '';
    document.getElementById('ytdStateWithheld').value = p.ytd_state_withheld || '';
    if (p.pay_date) {
      document.getElementById('payDate').value = p.pay_date;
      // Auto-set tax year from paystub pay date
      const payYear = parseInt(p.pay_date.split('-')[0]);
      if (payYear >= 2020 && payYear <= 2030) {
        document.getElementById('taxYear').value = payYear;
      }
    }

    // Show confirmation
    const parsed = document.getElementById('paystubParsed');
    parsed.innerHTML = `Parsed <strong>${p.employer || 'paystub'}</strong> — ` +
      `Pay date: ${p.pay_date}, YTD Gross: $${p.ytd_gross_wages.toLocaleString()}, ` +
      `Fed withheld: $${p.ytd_fed_withheld.toLocaleString()}, ` +
      `State withheld: $${p.ytd_state_withheld.toLocaleString()}` +
      (p.ytd_rsu_income > 0 ? `, RSU: $${p.ytd_rsu_income.toLocaleString()}` : '') +
      ` — values auto-filled below (edit if needed)`;
    parsed.classList.remove('hidden');

    // Auto-fetch stock price if not set yet
    const stockInput = document.getElementById('estimatedStockPrice');
    if (!stockInput.value || parseFloat(stockInput.value) === 0) {
      fetchStockPrice();
    }

    updateProjectedPreview();
    clearStatus('midStatus');
  } catch (err) {
    showStatus('Error parsing paystub: ' + err.message, 'error', 'midStatus');
  }
}

// Auto-fetch TSLA stock price
async function fetchStockPrice() {
  try {
    const res = await fetch('/stock_price/TSLA');
    const data = await res.json();
    if (data.price > 0) {
      document.getElementById('estimatedStockPrice').value = data.price;
      updateProjectedPreview();
    }
  } catch (e) { /* silently fail, user can enter manually */ }
}

// Live projected preview — runs client-side so user sees instant feedback
function updateProjectedPreview() {
  const payDate = document.getElementById('payDate').value;
  const ytdGross = parseFloat(document.getElementById('ytdGrossWages').value) || 0;
  const ytdRsu = parseFloat(document.getElementById('ytdRsuIncome').value) || 0;
  const ytdFed = parseFloat(document.getElementById('ytdFedWithheld').value) || 0;
  const ytdState = parseFloat(document.getElementById('ytdStateWithheld').value) || 0;
  const stockPrice = parseFloat(document.getElementById('estimatedStockPrice').value) || 0;
  const taxYear = parseInt(document.getElementById('taxYear').value) || 2025;

  const preview = document.getElementById('projectedPreview');
  if (!payDate || ytdGross <= 0) {
    preview.classList.add('hidden');
    return;
  }

  // Calculate year fraction
  const pd = new Date(payDate + 'T00:00:00');
  const yearStart = new Date(taxYear, 0, 1);
  const yearEnd = new Date(taxYear, 11, 31);
  const totalDays = (yearEnd - yearStart) / 86400000 + 1;
  const elapsed = Math.max(1, Math.min((pd - yearStart) / 86400000 + 1, totalDays));
  const frac = elapsed / totalDays;

  // Project base salary
  const ytdBase = ytdGross - ytdRsu;
  const projectedBase = ytdBase / frac;

  // Future RSU income from vesting events (only in tax year)
  let futureRsuIncome = 0;
  const tyStr = String(taxYear);
  for (const ev of vestingEvents) {
    if (ev.is_future && (ev.date || '').startsWith(tyStr)
        && ['rest. stock', 'rsu', 'restricted stock'].includes((ev.plan_type || '').toLowerCase())) {
      futureRsuIncome += (parseFloat(ev.shares) || 0) * stockPrice;
    }
  }

  const projectedW2 = projectedBase + ytdRsu + futureRsuIncome;

  // Withholding projection
  const estYtdRsuFed = ytdRsu * 0.22;
  const estYtdBaseFed = ytdFed - estYtdRsuFed;
  const projFedWH = estYtdBaseFed / frac + estYtdRsuFed + futureRsuIncome * 0.22;

  const estYtdRsuState = ytdRsu * 0.1023;
  const estYtdBaseState = ytdState - estYtdRsuState;
  const projStateWH = estYtdBaseState / frac + estYtdRsuState + futureRsuIncome * 0.1023;

  // Update preview
  document.getElementById('prevYearPct').textContent = (frac * 100).toFixed(1) + '%';
  document.getElementById('prevBaseSalary').textContent = fmt(projectedBase);
  document.getElementById('prevRsuIncome').textContent = fmt(futureRsuIncome);
  document.getElementById('prevW2Wages').textContent = fmt(projectedW2);
  document.getElementById('prevFedWH').textContent = fmt(projFedWH);
  document.getElementById('prevStateWH').textContent = fmt(projStateWH);
  preview.classList.remove('hidden');
}

// Trigger preview update on any relevant input change
['ytdGrossWages', 'ytdRsuIncome', 'ytdFedWithheld', 'ytdStateWithheld', 'payDate', 'estimatedStockPrice', 'taxYear'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateProjectedPreview);
});

// Vesting file upload
const vestDropzone = document.getElementById('vestDropzone');
const vestFileInput = document.getElementById('vestFileInput');

vestDropzone.addEventListener('dragover', e => { e.preventDefault(); vestDropzone.classList.add('active'); });
vestDropzone.addEventListener('dragleave', () => vestDropzone.classList.remove('active'));
vestDropzone.addEventListener('drop', e => {
  e.preventDefault();
  vestDropzone.classList.remove('active');
  if (e.dataTransfer.files.length) uploadVestingFile(e.dataTransfer.files[0]);
});
vestFileInput.addEventListener('change', () => {
  if (vestFileInput.files.length) uploadVestingFile(vestFileInput.files[0]);
});

async function uploadVestingFile(file) {
  const fd = new FormData();
  fd.append('file', file);
  showStatus('Parsing vesting schedule...', 'info', 'midStatus');

  try {
    const res = await fetch('/upload_vesting', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Upload failed');

    vestingEvents = data.events;
    renderVestTable();
    updateProjectedPreview();
    clearStatus('midStatus');
  } catch (err) {
    showStatus('Error: ' + err.message, 'error', 'midStatus');
  }
}

function addManualVest() {
  vestingEvents.push({
    date: '',
    shares: 0,
    plan_type: 'Rest. Stock',
    is_future: true,
    grant_reason: '',
    cost_basis_per_share: 0,
    price: 0,
    _manual: true,
  });
  renderVestTable();
}

function removeVest(idx) {
  vestingEvents.splice(idx, 1);
  renderVestTable();
}

function renderVestTable() {
  const container = document.getElementById('vestTableContainer');
  if (vestingEvents.length === 0) {
    container.innerHTML = '<p style="font-size:0.8rem;color:var(--muted)">No vesting events loaded. Upload an XLSX file or add manually.</p>';
    return;
  }

  const futureCount = vestingEvents.filter(e => e.is_future).length;
  const pastCount = vestingEvents.length - futureCount;

  let html = `<p style="font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem">${vestingEvents.length} events (${futureCount} future, ${pastCount} past)</p>`;
  html += `<table class="vest-table">
    <thead><tr>
      <th>Date</th><th>Shares</th><th>Type</th><th>Reason</th><th>FMV/share</th><th>Status</th><th></th>
    </tr></thead><tbody>`;

  vestingEvents.forEach((ev, i) => {
    const cls = ev.is_future ? 'future' : 'past';
    const badge = ev.is_future
      ? '<span class="badge future">Future</span>'
      : '<span class="badge past">Past</span>';

    if (ev._manual && ev.is_future) {
      html += `<tr class="${cls}">
        <td><input type="date" value="${ev.date}" onchange="vestingEvents[${i}].date=this.value" style="width:130px;font-size:0.8rem;padding:0.2rem;border:1px solid var(--border);border-radius:3px"></td>
        <td><input type="number" value="${ev.shares}" min="0" onchange="vestingEvents[${i}].shares=parseFloat(this.value)||0" style="width:70px;font-size:0.8rem;padding:0.2rem;border:1px solid var(--border);border-radius:3px"></td>
        <td><select onchange="vestingEvents[${i}].plan_type=this.value" style="font-size:0.8rem;padding:0.2rem;border:1px solid var(--border);border-radius:3px">
          <option value="Rest. Stock" ${ev.plan_type==='Rest. Stock'?'selected':''}>RSU</option>
          <option value="ESPP" ${ev.plan_type==='ESPP'?'selected':''}>ESPP</option>
        </select></td>
        <td>-</td>
        <td>-</td>
        <td>${badge}</td>
        <td><button class="btn-danger" onclick="removeVest(${i})">x</button></td>
      </tr>`;
    } else {
      const fmv = ev.cost_basis_per_share > 0 ? '$' + ev.cost_basis_per_share.toFixed(2) : '-';
      html += `<tr class="${cls}">
        <td>${ev.date}</td>
        <td>${ev.shares}</td>
        <td>${ev.plan_type}</td>
        <td>${ev.grant_reason || '-'}</td>
        <td>${fmv}</td>
        <td>${badge}</td>
        <td><button class="btn-danger" onclick="removeVest(${i})">x</button></td>
      </tr>`;
    }
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Planned sales
function addPlannedSale() {
  plannedSales.push({ proceeds: 0, cost_basis: 0, is_long_term: false });
  renderPlannedSales();
}

function removeSale(idx) {
  plannedSales.splice(idx, 1);
  renderPlannedSales();
}

function renderPlannedSales() {
  const container = document.getElementById('plannedSalesContainer');
  if (plannedSales.length === 0) {
    container.innerHTML = '<p style="font-size:0.8rem;color:var(--muted)">No planned sales. Click + to add one.</p>';
    return;
  }

  let html = '';
  plannedSales.forEach((sale, i) => {
    html += `<div class="sale-row">
      <label>Proceeds <input type="number" value="${sale.proceeds}" min="0" step="100" placeholder="$"
        onchange="plannedSales[${i}].proceeds=parseFloat(this.value)||0"></label>
      <label>Cost Basis <input type="number" value="${sale.cost_basis}" min="0" step="100" placeholder="$"
        onchange="plannedSales[${i}].cost_basis=parseFloat(this.value)||0"></label>
      <label><input type="checkbox" ${sale.is_long_term ? 'checked' : ''}
        onchange="plannedSales[${i}].is_long_term=this.checked"> Long-term</label>
      <button class="btn-danger" onclick="removeSale(${i})">x</button>
    </div>`;
  });
  container.innerHTML = html;
}

// Initialize empty states
renderVestTable();
renderPlannedSales();

async function calculateMidYear() {
  const midCalcBtn = document.getElementById('midCalcBtn');

  const payload = {
    filing_status: document.getElementById('filingStatus').value,
    tax_year: parseInt(document.getElementById('taxYear').value),
    estimated_payments: parseFloat(document.getElementById('estimatedPayments').value) || 0,
    paystub: {
      ytd_gross_wages: parseFloat(document.getElementById('ytdGrossWages').value) || 0,
      ytd_rsu_income: parseFloat(document.getElementById('ytdRsuIncome').value) || 0,
      ytd_fed_withheld: parseFloat(document.getElementById('ytdFedWithheld').value) || 0,
      ytd_state_withheld: parseFloat(document.getElementById('ytdStateWithheld').value) || 0,
      pay_date: document.getElementById('payDate').value,
    },
    vesting_events: vestingEvents,
    estimated_stock_price: parseFloat(document.getElementById('estimatedStockPrice').value) || 0,
    planned_sales: plannedSales,
    estimated_interest: parseFloat(document.getElementById('midEstInterest').value) || 0,
    mortgage_interest: parseFloat(document.getElementById('midMortgageInterest').value) || 0,
    property_taxes: parseFloat(document.getElementById('midPropertyTax').value) || 0,
    rental_pct: (parseFloat(document.getElementById('midRentalPct').value) || 0) / 100,
  };

  // Validate required fields
  if (!payload.paystub.pay_date) {
    showStatus('Please enter a pay date.', 'error', 'midStatus');
    return;
  }
  if (payload.paystub.ytd_gross_wages <= 0) {
    showStatus('Please enter YTD gross wages.', 'error', 'midStatus');
    return;
  }

  midCalcBtn.disabled = true;
  showStatus('Projecting full-year taxes...', 'info', 'midStatus');

  try {
    const res = await fetch('/calculate_midyear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Calculation failed');

    // Show projection banner
    const banner = document.getElementById('projectionBanner');
    const a = data.assumptions;
    banner.innerHTML = `<strong>PROJECTION</strong> — Based on data through ${a.pay_date} (${a.year_pct} of year). ` +
      `Stock price: $${a.estimated_stock_price.toLocaleString()}. ` +
      `${a.future_vest_count} future RSU vest(s), ${a.planned_sales_count} planned sale(s).`;
    banner.classList.remove('hidden');

    // Show assumptions
    displayAssumptions(data.assumptions);

    // Show results
    displayResults(data);
    clearStatus('midStatus');
  } catch (err) {
    showStatus('Error: ' + err.message, 'error', 'midStatus');
  } finally {
    midCalcBtn.disabled = false;
  }
}

function displayAssumptions(a) {
  const card = document.getElementById('assumptionsCard');
  card.innerHTML = `
    <h3>Projection Assumptions</h3>
    <div class="fields">
      <div class="field"><span>Year Progress</span><span>${a.year_pct}</span></div>
      <div class="field"><span>Est. Stock Price</span><span>$${a.estimated_stock_price.toLocaleString()}</span></div>
      <div class="field"><span>YTD Base Salary</span><span>${fmt(a.ytd_base_salary)}</span></div>
      <div class="field"><span>Projected Base (Full Year)</span><span>${fmt(a.projected_base_salary)}</span></div>
      <div class="field"><span>YTD RSU Income</span><span>${fmt(a.ytd_rsu_income)}</span></div>
      <div class="field"><span>Future RSU Income</span><span>${fmt(a.future_rsu_income)}</span></div>
      <div class="field"><span>Future ESPP Discount</span><span>${fmt(a.future_espp_discount)}</span></div>
      <div class="field"><span>Total Projected W-2</span><span>${fmt(a.projected_w2_wages)}</span></div>
      <div class="field"><span>Projected Fed Withheld</span><span>${fmt(a.projected_fed_withheld)}</span></div>
      <div class="field"><span>Projected State Withheld</span><span>${fmt(a.projected_state_withheld)}</span></div>
      <div class="field"><span>Planned Capital Gains</span><span>${fmt(a.total_planned_gains)}</span></div>
      <div class="field"><span>Salary Method</span><span>${a.method_base}</span></div>
      <div class="field" style="grid-column:1/-1"><span>RSU Method</span><span>${a.method_rsu}</span></div>
      <div class="field" style="grid-column:1/-1"><span>Withholding Method</span><span>${a.method_withholding}</span></div>
    </div>`;
  document.getElementById('assumptionsSection').classList.remove('hidden');
}
</script>

</body>
</html>
